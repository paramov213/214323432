\<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>MARS IMPERIAL v2.0</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto+Mono&display=swap');
        :root { --neon: #00f2ff; --gold: #ffcc00; --bg: #030508; --card: #0d1117; }
        body { background: var(--bg); color: #fff; font-family: 'Roboto Mono', monospace; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* Боковая панель */
        .sidebar { width: 300px; background: #000; border-right: 2px solid var(--neon); padding: 20px; display: flex; flex-direction: column; }
        .main { flex-grow: 1; display: grid; grid-template-rows: 80px 1fr 150px; }
        
        header { background: #080a0f; display: flex; justify-content: space-around; align-items: center; border-bottom: 1px solid #222; }
        .content { display: grid; grid-template-columns: 1fr 350px; gap: 1px; background: #1a1a1a; overflow: hidden; }
        .scroll-area { background: var(--bg); padding: 20px; overflow-y: auto; }

        .biz-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; }
        .biz-card { background: var(--card); border: 1px solid #222; padding: 15px; border-radius: 8px; transition: 0.3s; position: relative; }
        .biz-card:hover { border-color: var(--neon); transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,242,255,0.1); }
        .biz-card.locked { opacity: 0.5; filter: grayscale(1); }

        .stat-box { text-align: center; }
        .stat-val { font-family: 'Orbitron'; font-size: 1.4rem; color: var(--neon); text-shadow: 0 0 10px rgba(0,242,255,0.3); }

        button { background: #1f6feb; color: #fff; border: none; padding: 10px; cursor: pointer; font-family: 'Orbitron'; border-radius: 4px; transition: 0.2s; }
        button:hover { background: #388bfd; }
        button.buy { background: #238636; margin-top: 10px; width: 100%; }
        button.buy:disabled { background: #111; color: #444; }

        #auth-screen { position: fixed; inset: 0; background: #000; z-index: 10000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        input { padding: 12px; background: #111; border: 1px solid #333; color: #fff; margin: 5px; width: 250px; font-family: 'Orbitron'; }

        .chat-msg { margin-bottom: 8px; font-size: 0.85rem; border-left: 2px solid var(--neon); padding-left: 8px; }
        .tag { font-size: 0.6rem; padding: 2px 5px; background: var(--neon); color: #000; border-radius: 3px; font-weight: bold; }
    </style>
</head>
<body>

<div id="auth-screen">
    <h1 style="font-family:'Orbitron'; color:var(--neon); font-size: 2.5rem;">MARS IMPERIAL</h1>
    <input type="text" id="auth-user" placeholder="ЛОГИН">
    <input type="password" id="auth-pass" placeholder="ПАРОЛЬ">
    <button onclick="handleAuth('login')" style="width:275px; margin-top:10px;">ВОЙТИ В СИСТЕМУ</button>
    <button onclick="handleAuth('register')" style="width:275px; margin-top:5px; background:#222;">РЕГИСТРАЦИЯ</button>
</div>

<aside class="sidebar" id="sidebar-ui" style="display:none">
    <h2 class="stat-val" style="font-size: 1rem; margin-bottom: 20px;">МОИ ОБЪЕКТЫ</h2>
    <div id="my-assets-list" style="flex-grow:1; overflow-y:auto; font-size:0.8rem; color:#888;"></div>
    <hr style="border:0; border-top:1px solid #222; margin:20px 0;">
    <div id="player-list" style="font-size:0.75rem;"></div>
</aside>

<main class="main" id="game-ui" style="display:none">
    <header>
        <div class="stat-box"><span class="stat-val" id="ui-money" style="color:#4f4">0</span><br><small>КРЕДИТЫ (₮)</small></div>
        <div class="stat-box"><span class="stat-val" id="ui-energy">0</span><br><small>ЭНЕРГИЯ (MWh)</small></div>
        <div class="stat-box"><span class="stat-val" id="ui-price" style="color:var(--gold)">0</span><br><small>КУРС 100 MWh</small></div>
        <div>
            <button onclick="sellEnergy()" style="padding:15px 30px; font-size:1rem; border:2px solid var(--neon); background:transparent; color:var(--neon)">ПРОДАТЬ ВСЁ</button>
        </div>
    </header>

    <div class="content">
        <div class="scroll-area">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="font-family:'Orbitron'">РЫНОК ТЕХНОЛОГИЙ</h2>
                <div>
                    <button class="sec" onclick="showTab('shop')">МАГАЗИН</button>
                    <button class="sec" onclick="showTab('market')">P2P РЫНОК</button>
                    <button id="admin-btn" style="display:none; background:red;" onclick="showTab('admin')">ADMIN</button>
                </div>
            </div>

            <div id="shop-view" class="biz-grid"></div>
            
            <div id="market-view" style="display:none">
                <h3>БИРЖА ИГРОКОВ</h3>
                <div id="market-items"></div>
                <div style="background:#111; padding:15px; margin-top:20px;">
                    <h4>Выставить свой объект:</h4>
                    <select id="sell-asset-select" style="width:100%; padding:10px; background:#000; color:#fff;"></select>
                    <input type="number" id="sell-price" placeholder="Цена" style="width:200px">
                    <button onclick="createLot()">ПРОДАТЬ</button>
                </div>
            </div>

            <div id="admin-view" style="display:none">
                <h3>ТЕРМИНАЛ XEONE</h3>
                <input type="text" id="adm-target" placeholder="Ник игрока">
                <input type="number" id="adm-money" placeholder="Сумма">
                <button onclick="adminAction('giveMoney')">НАЧИСЛИТЬ</button>
            </div>
        </div>

        <div class="panel" style="background:#080a0f; padding:20px; border-left:1px solid #222; display:flex; flex-direction:column;">
            <h3 style="font-family:'Orbitron'; font-size:0.9rem; color:var(--neon)">СВЯЗЬ</h3>
            <div id="chat-box" style="flex-grow:1; overflow-y:auto; margin-bottom:10px; font-size:0.8rem;"></div>
            <input type="text" id="chat-input" placeholder="Сообщение..." onkeydown="if(event.key==='Enter')sendChat()">
        </div>
    </div>

    <footer style="background:#000; padding:10px 20px; font-size:0.7rem; color:#444; overflow:hidden;" id="log-box"></footer>
</main>

<script>
    let user = { username: '', password: '', money: 0, energy: 0, assets: [] };
    let world = { marketLots: [], messages: [], events: [] };
    
    // 12 бизнесов разного уровня
    const catalog = [
        { id: 'b1', name: 'Гидропоника', cost: 5000, gen: 0, inc: 15, lvl: 1 },
        { id: 'b2', name: 'Солнечный диск', cost: 12000, gen: 25, inc: 40, lvl: 1 },
        { id: 'b3', name: 'Ветро-ферма', cost: 35000, gen: 80, inc: 120, lvl: 1 },
        { id: 'b4', name: 'Скважина льда', cost: 80000, gen: 0, inc: 450, lvl: 2 },
        { id: 'b5', name: 'Геотермальная СТ', cost: 180000, gen: 400, inc: 900, lvl: 2 },
        { id: 'b6', name: 'Завод полимеров', cost: 450000, gen: -100, inc: 2800, lvl: 3 },
        { id: 'b7', name: 'Реактор деления', cost: 1200000, gen: 2500, inc: 5000, lvl: 4 },
        { id: 'b8', name: 'Лучевая башня', cost: 3000000, gen: 8000, inc: 12000, lvl: 5 },
        { id: 'b9', name: 'Квантовый майнер', cost: 8000000, gen: -1000, inc: 45000, lvl: 5 },
        { id: 'b10', name: 'Сингулярность', cost: 25000000, gen: 30000, inc: 150000, lvl: 6 },
        { id: 'b11', name: 'Звездные врата', cost: 100000000, gen: 100000, inc: 500000, lvl: 10 },
        { id: 'b12', name: 'Сфера Дайсона', cost: 999999999, gen: 1000000, inc: 5000000, lvl: 20 }
    ];

    async function handleAuth(action) {
        const u = document.getElementById('auth-user').value;
        const p = document.getElementById('auth-pass').value;
        const res = await fetch('/api/auth', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ username: u, password: p, action })
        });
        if(res.ok) {
            user = await res.json(); user = {...user.user, username: u, password: p};
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('game-ui').style.display = 'grid';
            document.getElementById('sidebar-ui').style.display = 'flex';
            if(u === 'xeone') document.getElementById('admin-btn').style.display = 'inline';
            renderShop();
            setInterval(gameTick, 500); // Быстрые тики (0.5 сек)
            setInterval(sync, 2500);
        } else alert("Доступ отклонен");
    }

    function renderShop() {
        const div = document.getElementById('shop-view');
        div.innerHTML = catalog.map(i => `
            <div class="biz-card">
                <span class="tag">LVL ${i.lvl}</span>
                <h4 style="margin:10px 0 5px 0">${i.name}</h4>
                <div style="font-size:0.7rem; color:#666">
                    Доход: +${i.inc}₮/с<br>Энергия: ${i.gen > 0 ? '+' : ''}${i.gen}
                </div>
                <button class="buy" onclick="buy('${i.id}')" ${user.money < i.cost ? 'disabled' : ''}>
                    ${i.cost.toLocaleString()} ₮
                </button>
            </div>
        `).join('');
    }

    function buy(id) {
        const item = catalog.find(x => x.id === id);
        if(user.money >= item.cost) {
            user.money -= item.cost;
            user.assets.push({...item, iid: Date.now()});
            addLog(`Приобретено: ${item.name}`);
            renderShop();
        }
    }

    async function sync() {
        const res = await fetch('/api/sync', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ username: user.username, password: user.password, data: user })
        });
        world = await res.json();
        updateUI();
    }

    function updateUI() {
        document.getElementById('ui-money').innerText = Math.floor(user.money).toLocaleString();
        document.getElementById('ui-energy').innerText = Math.floor(user.energy).toLocaleString();
        document.getElementById('ui-price').innerText = Math.floor(world.globalPrice) + " ₮";
        
        document.getElementById('chat-box').innerHTML = world.messages.map(m => `
            <div class="chat-msg"><b>${m.user}:</b> ${m.text}</div>
        `).join('');

        document.getElementById('my-assets-list').innerHTML = user.assets.map(a => `<div>• ${a.name}</div>`).join('');
        document.getElementById('player-list').innerHTML = "<b>ОНЛАЙН:</b><br>" + Object.keys(world.players).map(p => `• ${p}`).join('<br>');
        document.getElementById('log-box').innerHTML = world.events.slice(-3).reverse().map(e => `<div>> ${e}</div>`).join('');
        
        // Обновляем селект для продажи
        document.getElementById('sell-asset-select').innerHTML = user.assets.map((a,i) => `<option value="${i}">${a.name}</option>`).join('');
    }

    function gameTick() {
        user.assets.forEach(a => {
            user.money += (a.inc / 2); // Делим на 2, т.к. тик 0.5 сек
            user.energy += (a.gen / 2);
        });
        updateUI();
    }

    function sellEnergy() {
        if(user.energy > 0) {
            const amount = user.energy;
            const price = (amount / 100) * world.globalPrice * 0.9; // 10% налог
            user.energy = 0;
            user.money += price;
            addLog(`Продано ${Math.floor(amount)} MWh за ${Math.floor(price)} ₮`);
        }
    }

    function showTab(t) {
        document.getElementById('shop-view').style.display = t === 'shop' ? 'grid' : 'none';
        document.getElementById('market-view').style.display = t === 'market' ? 'block' : 'none';
        document.getElementById('admin-view').style.display = t === 'admin' ? 'block' : 'none';
    }

    function sendChat() {
        const i = document.getElementById('chat-input');
        fetch('/api/sync', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ username: user.username, password: user.password, chatMsg: i.value, data: user })
        });
        i.value = "";
    }

    async function adminAction(action) {
        const t = document.getElementById('adm-target').value;
        const v = document.getElementById('adm-money').value;
        await fetch('/api/admin/action', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ login: 'xeone', pass: '565811', action, target: t, value: v })
        });
    }

    function addLog(m) {
        world.events.push(m);
        updateUI();
    }
</script>
</body>
</html>
