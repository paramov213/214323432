<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>MARS COLONY v1.5 - Corp Wars</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto+Mono&display=swap');
        :root { --neon: #00f2ff; --danger: #ff0055; --bg: #05070a; }
        body { background: var(--bg); color: #e6edf3; font-family: 'Roboto Mono', monospace; margin: 0; }
        .app-shell { display: grid; grid-template-rows: 60px 1fr 200px; height: 100vh; }
        header { display: flex; justify-content: space-around; align-items: center; background: #0d1117; border-bottom: 2px solid var(--neon); }
        .main-content { display: grid; grid-template-columns: 350px 1fr 350px; background: #161b22; gap: 1px; }
        .panel { background: #0d1117; padding: 15px; overflow-y: auto; border: 1px solid #30363d; }
        
        .shield-bar { height: 5px; background: #333; margin-top: 5px; }
        .shield-fill { height: 100%; background: var(--neon); transition: width 0.3s; }
        .corp-tag { font-size: 0.7rem; padding: 2px 5px; border-radius: 3px; }

        button { background: #21262d; color: white; border: 1px solid #444; padding: 10px; cursor: pointer; font-family: 'Orbitron'; margin: 5px 0; width: 100%; }
        button:hover { border-color: var(--neon); }
        .stat-val { font-family: 'Orbitron'; color: var(--neon); }
        #auth-screen { position: fixed; inset: 0; background: #000; z-index: 10000; display: flex; justify-content: center; align-items: center; }
    </style>
</head>
<body>

<div id="auth-screen">
    <div style="text-align:center; border: 1px solid var(--neon); padding: 40px; background: #0d1117;">
        <h2 style="font-family:'Orbitron';">SELECT CORPORATION</h2>
        <input type="text" id="username-input" placeholder="LOGIN_ID" style="padding:10px; margin-bottom:10px;"><br>
        <select id="corp-select" style="padding:10px; width:100%; background:#000; color:#fff;">
            <option value="ARES">ARES (Red)</option>
            <option value="NEBULA">NEBULA (Green)</option>
            <option value="VOID">VOID (Cyan)</option>
        </select><br><br>
        <button onclick="login()">ESTABLISH LINK</button>
    </div>
</div>

<div class="app-shell">
    <header>
        <div>USER: <span id="name-tag" class="stat-val">-</span> <span id="corp-tag" class="corp-tag"></span></div>
        <div>CASH: <span id="stat-money" class="stat-val" style="color:#4f4">0</span> ₮</div>
        <div style="width:150px;">SHIELD: <div class="shield-bar"><div id="shield-fill" class="shield-fill"></div></div></div>
    </header>

    <div class="main-content">
        <div class="panel">
            <h3>FACTORY</h3>
            <button onclick="buy('Solar-T2', 5000, 40, 100)">Solar T2 (5k₮)</button>
            <button onclick="buy('Shield-Gen', 10000, 0, 0)">Repair Shield (10k₮)</button>
            <div id="assets-list"></div>
        </div>

        <div class="panel" style="display:flex; flex-direction:column;">
            <h3 id="price-val" style="text-align:center; font-size:2rem;">0 ₮</h3>
            <button onclick="sellEnergy()" style="background:var(--neon); color:#000;">SELL 100 MWh</button>
            <div id="chat-window" style="flex-grow:1; background:#000; margin:10px 0; padding:5px; font-size:0.8rem; overflow-y:auto;"></div>
            <input type="text" id="chat-input" placeholder="Communicate..." onkeydown="if(event.key==='Enter')sendChat()">
        </div>

        <div class="panel">
            <h3>GRID RAIDS (TARGETS)</h3>
            <div id="player-list"></div>
        </div>
    </div>

    <div class="panel" id="log-box" style="background:#000; color:#888; font-size:0.8rem;"></div>
</div>



<script>
    let user = { username: '', money: 0, energy: 0, assets: [], shield: 100 };
    let world = { messages: [] };
    let nextChatMsg = "";
    let raidTarget = null;

    async function login() {
        const name = document.getElementById('username-input').value;
        const corp = document.getElementById('corp-select').value;
        if (!name) return;
        const res = await fetch('/api/login', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ username: name, corp })
        });
        const data = await res.json();
        user = { ...user, ...data.user };
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('name-tag').innerText = name;
        document.getElementById('corp-tag').innerText = corp;
        setInterval(gameLoop, 1000);
        setInterval(sync, 2000);
    }

    function buy(name, cost, gen, inc) {
        if (name === 'Shield-Gen' && user.money >= 10000) {
            user.money -= 10000; user.shield = 100; return;
        }
        if (user.money >= cost) {
            user.money -= cost;
            user.assets.push({ name, gen, inc, id: Date.now() });
        }
    }

    function startRaid(target) {
        raidTarget = target;
        setTimeout(() => { raidTarget = null; }, 2000);
    }

    async function sync() {
        const res = await fetch('/api/sync', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ username: user.username, data: user, chatMsg: nextChatMsg, raidTarget })
        });
        nextChatMsg = ""; raidTarget = null;
        world = await res.json();
        user.shield = world.players[user.username].shield;
        user.money = world.players[user.username].money;
        updateUI();
    }

    function updateUI() {
        document.getElementById('stat-money').innerText = Math.floor(user.money);
        document.getElementById('price-val').innerText = Math.floor(world.globalPrice) + ' ₮';
        document.getElementById('shield-fill').style.width = user.shield + '%';
        
        const chat = document.getElementById('chat-window');
        chat.innerHTML = world.messages.map(m => `<div><b>${m.user}:</b> ${m.text}</div>`).join('');
        chat.scrollTop = chat.scrollHeight;

        document.getElementById('player-list').innerHTML = Object.keys(world.players).map(p => {
            if(p === user.username) return '';
            return `<div style="border-bottom:1px solid #333; padding:5px;">
                ${p} [${world.players[p].corp}]
                <button onclick="startRaid('${p}')" style="font-size:0.6rem; padding:2px;">RAID GRID</button>
            </div>`;
        }).join('');

        document.getElementById('log-box').innerHTML = world.events.slice(-5).map(e => `<div>> ${e}</div>`).reverse().join('');
    }

    function sendChat() {
        nextChatMsg = document.getElementById('chat-input').value;
        document.getElementById('chat-input').value = "";
    }

    function sellEnergy() {
        if (user.energy >= 100) {
            user.energy -= 100;
            user.money += (world.globalPrice * 100) * (1 - world.settings.taxRate);
        }
    }

    function gameLoop() {
        user.assets.forEach(a => {
            user.energy += a.gen / 10;
            user.money += (a.inc * world.settings.multiplier) / 10;
        });
    }
</script>
</body>
</html>
