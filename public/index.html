<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ú–ê–†–°: –í–´–ñ–ò–í–ê–ù–ò–ï v1.9</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto+Mono&display=swap');
        :root { --neon: #00f2ff; --pink: #ff0055; --bg: #030508; }
        body { background: var(--bg); color: #e6edf3; font-family: 'Roboto Mono', monospace; margin: 0; overflow: hidden; }
        .app-shell { display: grid; grid-template-rows: 70px 1fr 120px; height: 100vh; }
        header { background: #000; border-bottom: 2px solid var(--neon); display: flex; justify-content: space-around; align-items: center; }
        .main-content { display: grid; grid-template-columns: 350px 1fr 350px; gap: 1px; background: #1a1a1a; }
        .panel { background: #0d1117; padding: 15px; overflow-y: auto; border: 1px solid #21262d; }
        
        .tab-btn { background: #000; color: var(--neon); border: 1px solid var(--neon); padding: 8px 15px; cursor: pointer; font-family: 'Orbitron'; }
        .active-tab { background: var(--neon); color: #000; }
        .stat-label { font-size: 0.7rem; color: #8b949e; display: block; }
        .stat-val { font-family: 'Orbitron'; font-size: 1.1rem; color: var(--neon); }

        .item-card { border: 1px solid #30363d; padding: 12px; margin-bottom: 10px; border-radius: 6px; background: #161b22; }
        button { background: #238636; color: white; border: none; padding: 10px; cursor: pointer; font-family: 'Orbitron'; width: 100%; border-radius: 4px; }
        button:hover { background: #2ea043; }
        button.sec { background: #21262d; border: 1px solid #30363d; }

        #auth-screen { position: fixed; inset: 0; background: #000; z-index: 10000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        input { padding: 12px; background: #0d1117; border: 1px solid #30363d; color: #fff; margin-bottom: 10px; width: 280px; border-radius: 4px; }
    </style>
</head>
<body>

<div id="auth-screen">
    <h1 style="font-family:'Orbitron'; color:var(--neon); letter-spacing: 5px;">MARS PROTOCOL</h1>
    <p style="color:#555">–°–ò–°–¢–ï–ú–ê –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ö–û–õ–û–ù–ò–ï–ô</p><br>
    <input type="text" id="auth-user" placeholder="–õ–û–ì–ò–ù">
    <input type="password" id="auth-pass" placeholder="–ü–ê–†–û–õ–¨">
    <div style="display:flex; gap:10px;">
        <button onclick="handleAuth('login')">–í–•–û–î</button>
        <button onclick="handleAuth('register')" class="sec">–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø</button>
    </div>
</div>

<div class="app-shell" id="game-ui" style="display:none">
    <header>
        <div><span class="stat-label">–û–ü–ï–†–ê–¢–û–†</span><span id="ui-name" class="stat-val">-</span></div>
        <div><span class="stat-label">–ë–ê–õ–ê–ù–°</span><span id="ui-money" class="stat-val" style="color:#4f4">0</span> ‚ÇÆ</div>
        <div><span class="stat-label">–≠–ù–ï–†–ì–ò–Ø</span><span id="ui-energy" class="stat-val">0</span> MWh</div>
        <nav>
            <button onclick="switchTab('shop')" class="tab-btn active-tab" id="b-shop">–ú–ê–ì–ê–ó–ò–ù</button>
            <button onclick="switchTab('market')" class="tab-btn" id="b-market">–†–´–ù–û–ö</button>
            <button onclick="switchTab('admin')" id="admin-btn" class="tab-btn" style="display:none; color:red; border-color:red">–ê–î–ú–ò–ù</button>
        </nav>
    </header>

    <div class="main-content">
        <div class="panel" id="tab-content">
            <div id="shop-view">
                <h3>–ì–û–°. –ü–û–°–¢–ê–í–ö–ò</h3>
                <div id="shop-items"></div>
            </div>
            
            <div id="market-view" style="display:none">
                <h3>–¢–û–†–ì–û–í–ê–Ø –ü–õ–û–©–ê–î–ö–ê</h3>
                <div id="market-items"></div>
                <hr style="border:1px solid #222">
                <h4>–í–´–°–¢–ê–í–ò–¢–¨ –ù–ê –ü–†–û–î–ê–ñ–£</h4>
                <select id="sell-asset-select" style="width:100%; padding:10px; background:#000; color:#fff; border:1px solid #333;"></select>
                <input type="number" id="sell-price" placeholder="–¶–µ–Ω–∞ –≤ ‚ÇÆ" style="width:90%; margin-top:10px;">
                <button onclick="createLot()">–û–ü–£–ë–õ–ò–ö–û–í–ê–¢–¨ –û–ë–™–Ø–í–õ–ï–ù–ò–ï</button>
            </div>

            <div id="admin-view" style="display:none">
                <h3 style="color:red">–¢–ï–†–ú–ò–ù–ê–õ XEONE</h3>
                <label>–ö—É—Ä—Å –≠–Ω–µ—Ä–≥–∏–∏:</label><input type="number" id="adm-price"><button onclick="adminAction('setPrice')">–ò–ó–ú–ï–ù–ò–¢–¨</button>
                <label>–ù–∞–ª–æ–≥ (%):</label><input type="number" id="adm-tax"><button onclick="adminAction('setTax')">–£–°–¢–ê–ù–û–í–ò–¢–¨</button>
                <label>–ù–∏–∫ –∏–≥—Ä–æ–∫–∞:</label><input type="text" id="adm-target"><br>
                <label>–°—É–º–º–∞ ‚ÇÆ:</label><input type="number" id="adm-money"><button onclick="adminAction('giveMoney')">–ù–ê–ß–ò–°–õ–ò–¢–¨</button>
            </div>
        </div>

        <div class="panel" style="background:#000">
            <div style="text-align:center; padding:20px; border:1px solid #111; margin-bottom:20px;">
                <span class="stat-label">–¢–ï–ö–£–©–ê–Ø –°–¢–û–ò–ú–û–°–¢–¨ 100 MWh</span>
                <div id="price-display" style="font-size:3.5rem; font-family:'Orbitron'; color:var(--neon)">0 ‚ÇÆ</div>
                <small id="ui-tax" style="color:var(--pink)">–ù–∞–ª–æ–≥: 15%</small>
            </div>
            <button onclick="sellEnergy()" style="height:80px; font-size:1.2rem; background:var(--neon); color:#000;">–ü–†–û–î–ê–¢–¨ 500 MWh</button>
            
            <div id="chat-box" style="height:180px; overflow-y:auto; background:#05070a; margin-top:20px; padding:10px; font-size:0.8rem; border:1px solid #111;"></div>
            <input type="text" id="chat-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." style="width:100%; margin-top:5px;" onkeydown="if(event.key==='Enter')sendChat()">
        </div>

        <div class="panel">
            <h3>–í–ê–®–ò –û–ë–™–ï–ö–¢–´</h3>
            <div id="my-assets"></div>
            <hr style="border:1px solid #222">
            <h3>–ê–ö–¢–ò–í–ù–´–ï –°–í–Ø–ó–ò</h3>
            <div id="player-list" style="font-size:0.8rem; color:#888"></div>
        </div>
    </div>

    <div class="panel" id="log-box" style="background:#000; font-size:0.75rem; color:#444; border-top:1px solid #222"></div>
</div>

<script>
    let user = { username: '', password: '', money: 0, energy: 0, assets: [] };
    let world = { marketLots: [], messages: [], settings: { taxRate: 0.15 } };
    
    // –•–∞—Ä–¥–∫–æ—Ä–Ω—ã–π –±–∞–ª–∞–Ω—Å: –≤—ã—Å–æ–∫–∞—è —Ü–µ–Ω–∞, –Ω–∏–∑–∫–∞—è –ø—Ä–∏–±—ã–ª—å
    const items = [
        { id: 's1', name: '–°–æ–ª–Ω–µ—á–Ω–∞—è –ø–∞–Ω–µ–ª—å T1', cost: 12000, gen: 10, inc: 25 },
        { id: 's2', name: '–í–µ—Ç—Ä–æ–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä T1', cost: 45000, gen: 40, inc: 110 },
        { id: 'f1', name: '–¢–µ—Ä–º–æ—è–¥–µ—Ä–Ω—ã–π –º–∏–Ω–∏-—Ä–µ–∞–∫—Ç–æ—Ä', cost: 250000, gen: 300, inc: 800 }
    ];

    async function handleAuth(action) {
        const u = document.getElementById('auth-user').value;
        const p = document.getElementById('auth-pass').value;
        const res = await fetch('/api/auth', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ username: u, password: p, action })
        });
        if(res.ok) {
            const data = await res.json();
            user = { ...data.user, username: u, password: p };
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('game-ui').style.display = 'grid';
            document.getElementById('ui-name').innerText = u;
            if(u === 'xeone') document.getElementById('admin-btn').style.display = 'inline';
            renderShop();
            setInterval(gameLoop, 1000);
            setInterval(sync, 3000);
        } else alert("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ.");
    }

    function switchTab(tab) {
        document.getElementById('shop-view').style.display = tab === 'shop' ? 'block' : 'none';
        document.getElementById('market-view').style.display = tab === 'market' ? 'block' : 'none';
        document.getElementById('admin-view').style.display = tab === 'admin' ? 'block' : 'none';
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active-tab'));
        document.getElementById('b-' + tab)?.classList.add('active-tab');
    }

    function buyFromShop(id) {
        const item = items.find(i => i.id === id);
        if(user.money >= item.cost) {
            user.money -= item.cost;
            user.assets.push({...item, instanceId: Date.now()});
            addLog(`–ü—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω –æ–±—ä–µ–∫—Ç: ${item.name}`);
        }
    }

    async function sync() {
        const res = await fetch('/api/sync', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ username: user.username, password: user.password, data: user })
        });
        world = await res.json();
        updateUI();
    }

    function updateUI() {
        document.getElementById('ui-money').innerText = Math.floor(user.money).toLocaleString();
        document.getElementById('ui-energy').innerText = Math.floor(user.energy).toLocaleString();
        document.getElementById('price-display').innerText = Math.floor(world.globalPrice) + " ‚ÇÆ";
        document.getElementById('ui-tax').innerText = `–ù–∞–ª–æ–≥: ${Math.round(world.settings.taxRate * 100)}%`;
        
        document.getElementById('market-items').innerHTML = world.marketLots.map(l => `
            <div class="item-card">
                <b>${l.item.name}</b><br>
                <small>–í–ª–∞–¥–µ–ª–µ—Ü: ${l.seller}</small><br>
                –¶–µ–Ω–∞: <span style="color:#4f4">${l.price} ‚ÇÆ</span>
                <button onclick="buyLot(${l.id})" style="margin-top:5px;">–í–´–ö–£–ü–ò–¢–¨</button>
            </div>
        `).join('') || '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ª–æ—Ç–æ–≤';

        document.getElementById('my-assets').innerHTML = user.assets.map(a => `<div class="item-card" style="font-size:0.8rem">üì¶ ${a.name}</div>`).join('');
        document.getElementById('sell-asset-select').innerHTML = user.assets.map((a, i) => `<option value="${i}">${a.name}</option>`).join('');
        document.getElementById('chat-box').innerHTML = world.messages.map(m => `<div><b style="color:var(--neon)">${m.user}:</b> ${m.text}</div>`).join('');
        document.getElementById('player-list').innerHTML = Object.keys(world.players).map(p => `<div>‚Ä¢ ${p}</div>`).join('');
    }

    function gameLoop() {
        user.assets.forEach(a => {
            user.money += (a.inc * 0.1); // –î–æ—Ö–æ–¥ –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è –º–µ–¥–ª–µ–Ω–Ω–µ–µ
            user.energy += (a.gen * 0.1);
        });
        updateUI();
    }

    function sellEnergy() {
        if(user.energy >= 500) {
            user.energy -= 500;
            const gross = world.globalPrice * 5;
            const net = gross * (1 - world.settings.taxRate);
            user.money += net;
            addLog(`–ü—Ä–æ–¥–∞–∂–∞: +${Math.round(net)} ‚ÇÆ (–ù–∞–ª–æ–≥: ${Math.round(gross - net)})`);
        }
    }

    function renderShop() {
        document.getElementById('shop-items').innerHTML = items.map(i => `
            <div class="item-card">
                <b>${i.name}</b><br>
                –°—Ç–æ–∏–º–æ—Å—Ç—å: <span style="color:var(--neon)">${i.cost.toLocaleString()} ‚ÇÆ</span><br>
                <small>–í—ã—Ä–∞–±–æ—Ç–∫–∞: +${i.gen} MWh/s | –ü—Ä–∏–±—ã–ª—å: +${i.inc} ‚ÇÆ/s</small>
                <button onclick="buyFromShop('${i.id}')" style="margin-top:10px;">–ó–ê–ö–£–ü–ò–¢–¨</button>
            </div>
        `).join('');
    }

    async function adminAction(action) {
        const val = document.getElementById(action === 'setPrice' ? 'adm-price' : action === 'setTax' ? 'adm-tax' : 'adm-money').value;
        await fetch('/api/admin/action', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ login: 'xeone', pass: '565811', action, target: document.getElementById('adm-target').value, value: val })
        });
    }

    function sendChat() {
        const inp = document.getElementById('chat-input');
        if(!inp.value) return;
        fetch('/api/sync', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ username: user.username, password: user.password, chatMsg: inp.value, data: user })
        });
        inp.value = "";
    }

    function addLog(t) {
        const b = document.getElementById('log-box');
        b.innerHTML = `<div>[${new Date().toLocaleTimeString()}] ${t}</div>` + b.innerHTML;
    }
</script>
</body>
</html>
