<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>MARS ULTIMATE 1.8</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto+Mono&display=swap');
        :root { --neon: #00f2ff; --pink: #ff0055; --bg: #05070a; }
        body { background: var(--bg); color: #fff; font-family: 'Roboto Mono', monospace; margin: 0; overflow: hidden; }
        .app-shell { display: grid; grid-template-rows: 70px 1fr 150px; height: 100vh; }
        header { background: #000; border-bottom: 2px solid var(--neon); display: flex; justify-content: space-around; align-items: center; }
        .main-content { display: grid; grid-template-columns: 350px 1fr 350px; gap: 1px; background: #222; }
        .panel { background: #0d1117; padding: 15px; overflow-y: auto; border: 1px solid #161b22; }
        
        .tab-btn { background: #111; color: var(--neon); border: 1px solid var(--neon); padding: 5px 10px; cursor: pointer; margin-right: 5px; }
        .active-tab { background: var(--neon); color: #000; }

        .lot-card { border: 1px solid #333; padding: 10px; margin-bottom: 10px; background: #161b22; }
        button { background: #21262d; color: white; border: 1px solid #444; padding: 10px; cursor: pointer; font-family: 'Orbitron'; width: 100%; }
        button:hover { background: var(--neon); color: #000; }

        #auth-screen { position: fixed; inset: 0; background: #000; z-index: 10000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        input { padding: 10px; background: #111; border: 1px solid var(--neon); color: #fff; margin-bottom: 5px; width: 250px; }
    </style>
</head>
<body>

<div id="auth-screen">
    <h1 style="font-family:'Orbitron'; color:var(--neon)">MARS PROTOCOL</h1>
    <input type="text" id="auth-user" placeholder="LOGIN">
    <input type="password" id="auth-pass" placeholder="PASSWORD">
    <div style="display:flex; gap:10px;">
        <button onclick="handleAuth('login')">LOGIN</button>
        <button onclick="handleAuth('register')" style="border-color:var(--pink)">REGISTER</button>
    </div>
</div>

<div class="app-shell" id="game-ui" style="display:none">
    <header>
        <div>USER: <span id="ui-name" style="color:var(--neon)">-</span></div>
        <div>CASH: <span id="ui-money" style="color:#4f4">0</span> ₮</div>
        <div>
            <button onclick="switchTab('shop')" class="tab-btn active-tab" id="b-shop">SHOP</button>
            <button onclick="switchTab('market')" class="tab-btn" id="b-market">P2P MARKET</button>
            <button onclick="switchTab('admin')" id="admin-btn" class="tab-btn" style="display:none; border-color:red">ADMIN</button>
        </div>
    </header>

    <div class="main-content">
        <div class="panel" id="tab-content">
            <div id="shop-view">
                <h3>COLONY STORE</h3>
                <div id="shop-items"></div>
            </div>
            <div id="market-view" style="display:none">
                <h3>PLAYER MARKET</h3>
                <div id="market-items"></div>
                <hr>
                <h4>Sell your Asset</h4>
                <select id="sell-asset-select" style="width:100%; padding:5px;"></select>
                <input type="number" id="sell-price" placeholder="Price" style="width:90%">
                <button onclick="createLot()">POST LOT</button>
            </div>
            <div id="admin-view" style="display:none">
                <h3 style="color:red">XEONE OVERRIDE</h3>
                <label>Global Price:</label><input type="number" id="adm-price"><button onclick="adminAction('setPrice')">SET</button>
                <label>Volatility:</label><input type="number" id="adm-vol"><button onclick="adminAction('setVolatility')">SET</button>
                <label>Target User:</label><input type="text" id="adm-target"><br>
                <label>Add Money:</label><input type="number" id="adm-money"><button onclick="adminAction('giveMoney')">GIVE</button>
            </div>
        </div>

        <div class="panel" style="background:#05070a">
            <div id="price-display" style="font-size:3rem; text-align:center; font-family:'Orbitron'">0 ₮</div>
            <button onclick="sellEnergy()" style="height:60px; background:var(--neon); color:#000;">SELL 500 MWh</button>
            <div id="chat-box" style="height:200px; overflow-y:auto; background:#000; margin-top:20px; padding:10px; font-size:0.8rem;"></div>
            <input type="text" id="chat-input" placeholder="Enter message..." style="width:100%" onkeydown="if(event.key==='Enter')sendChat()">
        </div>

        <div class="panel">
            <h3>MY ASSETS</h3>
            <div id="my-assets"></div>
            <hr>
            <h3>COLONISTS</h3>
            <div id="player-list"></div>
        </div>
    </div>

    <div class="panel" id="log-box" style="background:#000; font-size:0.7rem; color:#666;"></div>
</div>

<script>
    let user = { username: '', password: '', money: 0, energy: 0, assets: [] };
    let world = { marketLots: [], messages: [] };
    let currentTab = 'shop';

    const items = [
        { id: 's1', name: 'Solar T1', cost: 5000, gen: 15, inc: 50 },
        { id: 'f1', name: 'Fusion Core', cost: 100000, gen: 1000, inc: 5000 }
    ];

    async function handleAuth(action) {
        const u = document.getElementById('auth-user').value;
        const p = document.getElementById('auth-pass').value;
        const res = await fetch('/api/auth', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ username: u, password: p, action })
        });
        if(res.ok) {
            const data = await res.json();
            user = { ...data.user, username: u, password: p };
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('game-ui').style.display = 'grid';
            document.getElementById('ui-name').innerText = u;
            if(u === 'xeone') document.getElementById('admin-btn').style.display = 'inline';
            renderShop();
            setInterval(gameLoop, 1000);
            setInterval(sync, 2000);
        } else alert("Ошибка доступа");
    }

    function switchTab(tab) {
        currentTab = tab;
        document.getElementById('shop-view').style.display = tab === 'shop' ? 'block' : 'none';
        document.getElementById('market-view').style.display = tab === 'market' ? 'block' : 'none';
        document.getElementById('admin-view').style.display = tab === 'admin' ? 'block' : 'none';
        
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active-tab'));
        document.getElementById('b-' + tab)?.classList.add('active-tab');
    }

    function buyFromShop(id) {
        const item = items.find(i => i.id === id);
        if(user.money >= item.cost) {
            user.money -= item.cost;
            user.assets.push({...item, instanceId: Date.now()});
        }
    }

    async function createLot() {
        const assetIndex = document.getElementById('sell-asset-select').value;
        const price = document.getElementById('sell-price').value;
        if(assetIndex === "" || !price) return;

        const item = user.assets[assetIndex];
        const newLot = { item, price: Number(price) };
        user.assets.splice(assetIndex, 1);
        
        await fetch('/api/sync', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ ...user, newLot })
        });
    }

    async function buyLot(lotId) {
        const res = await fetch('/api/market/buy', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ buyerName: user.username, lotId })
        });
        if(res.ok) sync();
    }

    async function adminAction(action) {
        const val = action === 'setPrice' ? document.getElementById('adm-price').value :
                    action === 'setVolatility' ? document.getElementById('adm-vol').value :
                    document.getElementById('adm-money').value;
        const target = document.getElementById('adm-target').value;

        await fetch('/api/admin/action', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ login: 'xeone', pass: '565811', action, target, value: val })
        });
    }

    async function sync() {
        const res = await fetch('/api/sync', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ username: user.username, password: user.password, data: user })
        });
        world = await res.json();
        updateUI();
    }

    function updateUI() {
        document.getElementById('ui-money').innerText = Math.floor(user.money).toLocaleString();
        document.getElementById('price-display').innerText = Math.floor(world.globalPrice) + " ₮";
        
        // Рендер рынка
        document.getElementById('market-items').innerHTML = world.marketLots.map(l => `
            <div class="lot-card">
                <b>${l.item.name}</b> [Продавец: ${l.seller}]<br>
                Цена: <span style="color:#4f4">${l.price} ₮</span>
                <button onclick="buyLot(${l.id})" style="font-size:0.7rem">BUY</button>
            </div>
        `).join('');

        // Рендер моих активов и селекта для продажи
        document.getElementById('my-assets').innerHTML = user.assets.map(a => `<div>• ${a.name}</div>`).join('');
        document.getElementById('sell-asset-select').innerHTML = user.assets.map((a, i) => `<option value="${i}">${a.name}</option>`).join('');

        document.getElementById('chat-box').innerHTML = world.messages.map(m => `<div><b>${m.user}:</b> ${m.text}</div>`).join('');
        document.getElementById('player-list').innerHTML = Object.keys(world.players).map(p => `<div>${p}</div>`).join('');
    }

    function gameLoop() {
        user.assets.forEach(a => {
            user.money += a.inc;
            user.energy += a.gen;
        });
        updateUI();
    }

    function renderShop() {
        document.getElementById('shop-items').innerHTML = items.map(i => `
            <div class="lot-card">
                <b>${i.name}</b> (${i.cost} ₮)<br>
                <button onclick="buyFromShop('${i.id}')">BUY FROM STORE</button>
            </div>
        `).join('');
    }

    function sendChat() {
        const inp = document.getElementById('chat-input');
        fetch('/api/sync', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ username: user.username, password: user.password, chatMsg: inp.value, data: user })
        });
        inp.value = "";
    }

    function sellEnergy() {
        if(user.energy >= 500) {
            user.energy -= 500;
            user.money += (world.globalPrice * 500);
        }
    }
</script>
</body>
</html>
