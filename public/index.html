<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Colony Game v2</title>
    <style>
        :root { --neon: #00f2ff; --pink: #ff0055; --gold: #ffcc00; --bg: #0d1117; }
        body { background: var(--bg); color: #c9d1d9; font-family: 'Segoe UI', sans-serif; margin: 0; }
        .grid { display: grid; grid-template-columns: 300px 1fr 350px; gap: 20px; padding: 20px; }
        .card { background: #161b22; border: 1px solid #30363d; padding: 15px; border-radius: 10px; }
        .stat-box { font-size: 1.2rem; margin-bottom: 10px; }
        .val { color: var(--neon); font-weight: bold; }
        button { background: #21262d; color: white; border: 1px solid #f0f6fc1a; padding: 10px; cursor: pointer; width: 100%; border-radius: 6px; margin: 5px 0; }
        button:hover { background: #30363d; border-color: var(--neon); }
        #auth-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .admin-only { border: 2px solid var(--gold); display: none; margin-top: 15px; }
        .banned { display: none; text-align: center; color: var(--pink); font-size: 3rem; margin-top: 20%; }
    </style>
</head>
<body>

<div id="auth-screen">
    <div class="card" style="width: 300px; text-align: center;">
        <h2>Вход в Систему</h2>
        <input type="text" id="username-input" placeholder="Ваш позывной..." style="padding: 10px; width: 80%;">
        <button onclick="login()">Начать Колонизацию</button>
    </div>
</div>

<div id="ban-screen" class="banned">ВЫ ИЗГНАНЫ ИЗ КОЛОНИИ (BANNED)</div>

<div id="game-ui" style="display:none;">
    <header style="padding: 20px; border-bottom: 1px solid #30363d; display: flex; justify-content: space-between;">
        <div class="stat-box">Колонист: <span id="display-name" class="val">?</span></div>
        <div class="stat-box">Баланс: <span id="display-money" class="val" style="color:#4f4">0</span> ₮</div>
        <div class="stat-box">Энергия: <span id="display-energy" class="val">0</span> MWh</div>
        <button onclick="showAdmin()" style="width: auto;">Admin</button>
    </header>

    <div class="grid">
        <div class="card">
            <h3>Промышленность</h3>
            <button onclick="buyAsset('Mini-Solar', 1200, 15, 40)">Солнечная панель (1200₮)</button>
            <button onclick="buyAsset('Wind-Turbine', 3000, 40, 100)">Ветряк (3000₮)</button>
            <button onclick="buyAsset('Nuclear-Cell', 15000, 500, 1000)">Ядерная ячейка (15к ₮)</button>
            <hr style="border-color: #333;">
            <div id="asset-list"></div>
        </div>

        <div class="card">
            <h3>Глобальный Рынок</h3>
            <div style="text-align: center; font-size: 4rem; margin: 20px 0;" id="market-price">0 ₮</div>
            <p>Текущий множитель дохода: <span id="display-mult" class="val">1</span>x</p>
            <button onclick="sellEnergy()" style="height: 60px; font-size: 1.2rem; color: #4f4;">ПРОДАТЬ 50 MWh</button>
            <div id="log-box" style="height: 150px; overflow-y: auto; background: #000; padding: 10px; font-size: 0.8rem; margin-top: 20px;"></div>
        </div>

        <div class="card">
            <h3>Список игроков (Live)</h3>
            <div id="player-list"></div>
            
            <div id="admin-panel" class="card admin-only">
                <h4 style="color: var(--gold);">Console: Admin</h4>
                <input type="text" id="admin-target" placeholder="Имя игрока">
                <button onclick="adminAction('ban')">Забанить</button>
                <button onclick="adminAction('giveMoney', 50000)">Дать 50к ₮</button>
                <button onclick="adminAction('setMultiplier', 10)">Включить X10</button>
            </div>
        </div>
    </div>
</div>

<script>
    let currentUser = null;
    let localPlayer = { money: 0, energy: 0, assets: [] };
    let world = {};
    let adminPass = "";

    async function login() {
        const name = document.getElementById('username-input').value;
        if (!name) return;
        const res = await fetch('/api/login', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ username: name })
        });
        const data = await res.json();
        currentUser = name;
        localPlayer = data.user;
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('game-ui').style.display = 'block';
        document.getElementById('display-name').innerText = name;
        startLoops();
    }

    function buyAsset(name, cost, gen, inc) {
        if (localPlayer.money >= cost) {
            localPlayer.money -= cost;
            localPlayer.assets.push({ name, gen, inc });
            addLog(`Куплено: ${name}`);
        }
    }

    function sellEnergy() {
        if (localPlayer.energy >= 50) {
            localPlayer.energy -= 50;
            localPlayer.money += 50 * world.globalPrice;
            addLog(`Продано 50 MWh за ${Math.floor(50 * world.globalPrice)}₮`);
        }
    }

    async function sync() {
        try {
            const res = await fetch('/api/sync', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ username: currentUser, data: localPlayer })
            });
            const data = await res.json();
            if (data.banned) {
                document.getElementById('game-ui').style.display = 'none';
                document.getElementById('ban-screen').style.display = 'block';
                return;
            }
            world = data;
            updateUI();
        } catch(e) { console.log("Sync error"); }
    }

    function updateUI() {
        document.getElementById('display-money').innerText = Math.floor(localPlayer.money);
        document.getElementById('display-energy').innerText = Math.floor(localPlayer.energy);
        document.getElementById('market-price').innerText = Math.floor(world.globalPrice) + ' ₮';
        document.getElementById('display-mult').innerText = world.multiplier;
        
        // Список активов
        document.getElementById('asset-list').innerHTML = localPlayer.assets.map(a => 
            `<div style="font-size:0.8rem; border-bottom:1px solid #333">${a.name} (+${a.inc}₮/с)</div>`).join('');

        // События
        document.getElementById('log-box').innerHTML = world.events.map(e => `<div>> ${e}</div>`).reverse().join('');

        // Список игроков
        document.getElementById('player-list').innerHTML = Object.keys(world.players).map(p => 
            `<div>${p} - ${Math.floor(world.players[p].money)}₮ ${world.players[p].isBanned ? '❌' : '✅'}</div>`).join('');
    }

    function addLog(msg) {
        const lb = document.getElementById('log-box');
        lb.innerHTML = `<div>> ${msg}</div>` + lb.innerHTML;
    }

    function showAdmin() {
        adminPass = prompt("Admin Password?");
        if (adminPass === 'admin1337') document.getElementById('admin-panel').style.display = 'block';
    }

    async function adminAction(command, value = null) {
        const target = document.getElementById('admin-target').value;
        await fetch('/api/admin/command', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ password: adminPass, command, target, value: value || 10 })
        });
        sync();
    }

    function startLoops() {
        setInterval(() => {
            localPlayer.assets.forEach(a => {
                localPlayer.energy += a.gen / 10;
                localPlayer.money += (a.inc * world.multiplier) / 10;
            });
            updateUI();
        }, 1000);
        setInterval(sync, 2000); // Синхрон с сервером каждые 2 сек
    }
</script>
</body>
</html>
