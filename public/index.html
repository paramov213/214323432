<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>MARS COLONY v2.2</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto+Mono&display=swap');
        :root { --neon: #00f2ff; --gold: #ffcc00; --bg: #030508; --card: #0d1117; --red: #ff4444; }
        body { background: var(--bg); color: #fff; font-family: 'Roboto Mono', monospace; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 300px; background: #000; border-right: 2px solid var(--neon); padding: 20px; display: flex; flex-direction: column; }
        .main { flex-grow: 1; display: grid; grid-template-rows: 80px 1fr 100px; }
        header { background: #080a0f; display: flex; justify-content: space-around; align-items: center; border-bottom: 1px solid #222; }
        .scroll-area { background: var(--bg); padding: 20px; overflow-y: auto; }
        .biz-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .biz-card { background: var(--card); border: 1px solid #222; padding: 15px; border-radius: 8px; }
        .stat-val { font-family: 'Orbitron'; font-size: 1.2rem; color: var(--neon); }
        button { background: #1f6feb; color: #fff; border: none; padding: 10px; cursor: pointer; font-family: 'Orbitron'; border-radius: 4px; }
        .miner-btn { background: linear-gradient(45deg, #00f2ff, #0066ff); height: 60px; font-weight: bold; margin-bottom: 20px; }
        .loan-panel { background: #1a0a0a; border: 1px solid var(--red); padding: 10px; margin-top: 10px; border-radius: 5px; }
        #auth-screen { position: fixed; inset: 0; background: #000; z-index: 10000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        input { padding: 10px; background: #111; border: 1px solid #333; color: #fff; margin: 5px; width: 250px; }
        .chat-line { font-size: 0.8rem; margin-bottom: 5px; border-left: 2px solid var(--neon); padding-left: 5px; }
    </style>
</head>
<body>

<div id="auth-screen">
    <h1 style="font-family:'Orbitron'; color:var(--neon)">MARS OS v2.2</h1>
    <input type="text" id="auth-user" placeholder="ЛОГИН">
    <input type="password" id="auth-pass" placeholder="ПАРОЛЬ">
    <button onclick="handleAuth('login')" style="width:275px; margin-top:10px;">ВОЙТИ</button>
    <button onclick="handleAuth('register')" style="width:275px; margin-top:5px; background:#222;">РЕГИСТРАЦИЯ</button>
</div>

<aside class="sidebar" id="sidebar-ui" style="display:none">
    <button class="miner-btn" onclick="manualMine()">⛏ ДОБЫЧА (10₮)</button>
    
    <div class="loan-panel">
        <small style="color:var(--red)">КРЕДИТ</small>
        <div id="loan-info" style="font-size:0.8rem;">Долг: 0₮</div>
        <button onclick="takeLoan(50000)" style="font-size:0.6rem; background:var(--red); width:100%; margin-top:5px;">ВЗЯТЬ 50к</button>
        <button onclick="payLoan()" id="pay-btn" style="font-size:0.6rem; background:#238636; width:100%; margin-top:5px; display:none">ВЫПЛАТИТЬ</button>
    </div>

    <h3 style="font-family:'Orbitron'; font-size: 0.8rem; margin-top:20px;">ОБЪЕКТЫ</h3>
    <div id="my-assets-list" style="flex-grow:1; overflow-y:auto; font-size:0.75rem;"></div>
</aside>

<main class="main" id="game-ui" style="display:none">
    <header>
        <div><span class="stat-val" id="ui-money">0</span> ₮</div>
        <div><span class="stat-val" id="ui-energy">0</span> MWh</div>
        <div><span class="stat-val" id="ui-price" style="color:var(--gold)">0</span> ₮/ед</div>
        <button onclick="sellEnergy()" style="background:var(--neon); color:#000;">ПРОДАТЬ ЭНЕРГИЮ</button>
    </header>

    <div style="display:grid; grid-template-columns: 1fr 300px; background:#111;">
        <div class="scroll-area">
            <div style="margin-bottom:20px;">
                <button onclick="showTab('shop')">МАГАЗИН</button>
                <button onclick="showTab('market')">РЫНОК</button>
                <button id="admin-btn" style="display:none; background:red;" onclick="showTab('admin')">ADMIN</button>
            </div>

            <div id="shop-view" class="biz-grid"></div>
            
            <div id="market-view" style="display:none">
                <div id="market-items" class="biz-grid"></div>
                <div style="background:var(--card); padding:20px; margin-top:30px; border:1px solid var(--neon);">
                    <h4>ВЫСТАВИТЬ НА ПРОДАЖУ</h4>
                    <select id="sell-asset-select" style="width:100%; padding:10px; background:#000; color:#fff;"></select>
                    <input type="number" id="sell-price" placeholder="Цена" style="width:200px; margin-top:10px;">
                    <button onclick="createLot()">ВЫСТАВИТЬ</button>
                </div>
            </div>

            <div id="admin-view" style="display:none">
                <h3>УПРАВЛЕНИЕ XEONE</h3>
                <input type="text" id="adm-target" placeholder="Игрок">
                <input type="number" id="adm-money" placeholder="Сумма">
                <button onclick="adminAction('giveMoney')">ДОБАВИТЬ ₮</button>
                <input type="number" id="adm-price" placeholder="Курс">
                <button onclick="adminAction('setPrice')">УСТАНОВИТЬ КУРС</button>
            </div>
        </div>

        <div style="background:#000; padding:15px; border-left:1px solid #222; display:flex; flex-direction:column;">
            <div id="chat-box" style="flex-grow:1; overflow-y:auto;"></div>
            <input type="text" id="chat-input" placeholder="Сообщение..." onkeydown="if(event.key==='Enter')sendChat()">
        </div>
    </div>

    <footer id="log-box" style="background:#000; padding:10px; font-size:0.7rem; color:#555;"></footer>
</main>

<script>
    let user = { username: '', password: '', money: 0, energy: 0, assets: [], loan: 0 };
    let world = { marketLots: [], messages: [] };
    
    const catalog = [
        { id: 'b1', name: 'Гидропоника', cost: 8000, gen: 0, inc: 40 },
        { id: 'b2', name: 'Солнечная панель', cost: 15000, gen: 40, inc: 60 },
        { id: 'b3', name: 'Ветрогенератор', cost: 45000, gen: 120, inc: 150 },
        { id: 'b4', name: 'Термо-шахта', cost: 120000, gen: -100, inc: 1000 },
        { id: 'b5', name: 'Ядерный блок', cost: 900000, gen: 2500, inc: 5000 }
    ];

    async function handleAuth(action) {
        const u = document.getElementById('auth-user').value;
        const p = document.getElementById('auth-pass').value;
        const res = await fetch('/api/auth', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ username: u, password: p, action })
        });
        if(res.ok) {
            const d = await res.json(); 
            user = {...d.user, username: u, password: p};
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('game-ui').style.display = 'grid';
            document.getElementById('sidebar-ui').style.display = 'flex';
            if(u === 'xeone') document.getElementById('admin-btn').style.display = 'inline';
            renderShop();
            setInterval(() => {
                user.assets.forEach(a => { user.money += a.inc/2; user.energy += a.gen/2; });
                updateUI();
            }, 500);
            setInterval(sync, 3000);
        } else alert("Ошибка входа");
    }

    function manualMine() { user.money += 10; updateUI(); }

    async function sync() {
        const res = await fetch('/api/sync', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ username: user.username, password: user.password, data: user })
        });
        world = await res.json();
        const me = world.players[user.username];
        user.money = me.money; user.energy = me.energy; user.assets = me.assets; user.loan = me.loan;
        updateUI();
    }

    function updateUI() {
        document.getElementById('ui-money').innerText = Math.floor(user.money).toLocaleString();
        document.getElementById('ui-energy').innerText = Math.floor(user.energy).toLocaleString();
        document.getElementById('ui-price').innerText = Math.floor(world.globalPrice);
        document.getElementById('loan-info').innerText = `Долг: ${user.loan}₮`;
        document.getElementById('pay-btn').style.display = user.loan > 0 ? 'block' : 'none';
        
        document.getElementById('my-assets-list').innerHTML = user.assets.map(a => `<div style="padding:5px; border-bottom:1px solid #111;">• ${a.name}</div>`).join('');
        document.getElementById('sell-asset-select').innerHTML = user.assets.map((a,i) => `<option value="${i}">${a.name}</option>`).join('');

        document.getElementById('market-items').innerHTML = world.marketLots.map(l => `
            <div class="biz-card">
                <b>${l.item.name}</b><br><small>Владелец: ${l.seller}</small>
                <div style="color:var(--gold); margin:10px 0;">${l.price} ₮</div>
                <button onclick="buyLot(${l.id})" style="width:100%">КУПИТЬ</button>
            </div>
        `).join('');

        document.getElementById('chat-box').innerHTML = world.messages.map(m => `<div class="chat-line"><b>${m.user}:</b> ${m.text}</div>`).join('');
    }

    async function createLot() {
        const idx = document.getElementById('sell-asset-select').value;
        const price = document.getElementById('sell-price').value;
        if(idx === "" || !price) return;
        const lotItem = user.assets[idx];
        user.assets.splice(idx, 1);
        await fetch('/api/sync', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ username: user.username, password: user.password, data: user, newLot: { item: lotItem, price: Number(price) } })
        });
        sync();
    }

    async function buyLot(id) {
        await fetch('/api/market/buy', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ buyerName: user.username, lotId: id })
        });
        sync();
    }

    function renderShop() {
        document.getElementById('shop-view').innerHTML = catalog.map(i => `
            <div class="biz-card">
                <b>${i.name}</b><br><small>${i.cost}₮</small>
                <button onclick="buy('${i.id}')" style="width:100%; margin-top:10px; background:#238636">КУПИТЬ</button>
            </div>
        `).join('');
    }

    function buy(id) {
        const i = catalog.find(x => x.id === id);
        if(user.money >= i.cost) { user.money -= i.cost; user.assets.push({...i, iid: Date.now()}); updateUI(); }
    }

    function sellEnergy() {
        if(user.energy > 0) { user.money += (user.energy / 100) * world.globalPrice; user.energy = 0; }
    }

    async function takeLoan(a) { fetch('/api/loan', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:user.username, amount:a})}).then(()=>sync()); }
    function payLoan() { if(user.money >= user.loan) { user.money -= user.loan; user.loan = 0; sync(); } }
    function showTab(t) { 
        document.getElementById('shop-view').style.display = t === 'shop' ? 'grid' : 'none';
        document.getElementById('market-view').style.display = t === 'market' ? 'block' : 'none';
        document.getElementById('admin-view').style.display = t === 'admin' ? 'block' : 'none';
    }
    function sendChat() {
        const i = document.getElementById('chat-input');
        fetch('/api/sync', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:user.username, password:user.password, chatMsg:i.value, data:user})});
        i.value = "";
    }
    async function adminAction(action) {
        const t = document.getElementById('adm-target').value;
        const v = document.getElementById('adm-money').value || document.getElementById('adm-price').value;
        await fetch('/api/admin/action', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({login:'xeone', pass:'565811', action, target:t, value:v})});
        sync();
    }
</script>
</body>
</html>
